- name: Pick kubectl or 'k3s kubectl'
  shell: command -v kubectl >/dev/null 2>&1 && echo kubectl || echo 'k3s kubectl'
  args:
    executable: /bin/bash
  register: kubectl_cmd
  changed_when: false
- name: Find Jenkins pod and namespace
  shell: '{{ kubectl_cmd.stdout }} get pods -A -l app=jenkins -o jsonpath=''{.items[0].metadata.namespace}
    {.items[0].metadata.name}''

    '
  args:
    executable: /bin/bash
  register: pod_info
  changed_when: false
  failed_when: pod_info.stdout | trim == ""
- name: Set facts
  set_fact:
    jns: '{{ (pod_info.stdout | trim).split('' '')[0] }}'
    jpod: '{{ (pod_info.stdout | trim).split('' '')[1] }}'
- name: Get crumb JSON (single line)
  shell: '{{ kubectl_cmd.stdout }} -n "{{ jns }}" exec -i "{{ jpod }}" -- bash -lc
    ''curl -sS -u {{ JENKINS_ADMIN_USER }}:{{ JENKINS_ADMIN_PASS }} "http://localhost:{{
    JENKINS_API_PORT }}/crumbIssuer/api/json"''

    '
  args:
    executable: /bin/bash
  register: crumb_json
  changed_when: false
  failed_when: crumb_json.rc != 0 or (crumb_json.stdout | trim) == ""
- name: Parse JSON to object
  set_fact:
    _crumb_obj: '{{ crumb_json.stdout | from_json }}'
- name: Build header string
  set_fact:
    crumb_header: '{{ _crumb_obj.crumbRequestField ~ '': '' ~ _crumb_obj.crumb }}'
- name: Print header
  debug:
    msg:
    - 'Namespace: {{ jns }}'
    - 'Pod: {{ jpod }}'
    - 'CSRF header: {{ crumb_header }}'
